{%- if tools %}
<|tools|>
{{ tools | tojson }}
<|endoftools|>
{%- endif %}

{%- for message in messages %}
    {%- if message['role'] == 'system' %}
<|im_start|>system
{{ message['content'] }}<|im_end|>
    {%- elif message['role'] == 'user' %}
<|im_start|>user
{{ message['content'] }}<|im_end|>
    {%- elif message['role'] == 'assistant' %}
<|im_start|>assistant
        {%- if message.get('tool_calls') %}
<tool_call>
            {%- for tool_call in message['tool_calls'] %}
{"name": "{{ tool_call['function']['name'] }}", "arguments": {{ tool_call['function']['arguments'] }}, "id": "{{ tool_call.id if tool_call.id else 'call_' + range(1000000) | random | string }}"}{% if not loop.last %},{% endif %}
            {%- endfor %}
</tool_call>
        {%- else %}
{{ message['content'] }}
        {%- endif %}<|im_end|>
    {%- elif message['role'] == 'tool' %}
<|im_start|>tool
{{ message['content'] }}<|im_end|>
    {%- endif %}
{%- endfor %}
<|im_start|>assistant