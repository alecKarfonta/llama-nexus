server {
    listen 80;
    server_name localhost;
    
    # Use Docker's internal DNS resolver for dynamic upstreams
    resolver 127.0.0.11 valid=10s ipv6=off;
    resolver_timeout 5s;

    # Proxy management API (8700) and llama API (8600)
    # Specific management endpoints first
    location /api/v1/ {
        proxy_pass http://backend-api:8700/api/v1/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Health endpoint from management API
    location = /api/health {
        proxy_pass http://backend-api:8700/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket endpoint for real-time updates
    location = /ws {
        proxy_pass http://backend-api:8700/ws;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
    }

    # Service management endpoints to backend API (must come before other /v1/ routes)
    location ~ ^/v1/service/(.*)$ {
        proxy_pass http://backend-api:8700/v1/service/$1$is_args$args;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Resources endpoint to backend API
    location = /v1/resources {
        proxy_pass http://backend-api:8700/v1/resources;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Model management endpoints to backend API (must come before other /v1/ routes)
    location = /v1/models {
        proxy_pass http://backend-api:8700/v1/models;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    location ~ ^/v1/models/(.*)$ {
        proxy_pass http://backend-api:8700/v1/models/$1$is_args$args;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Token usage endpoints to backend API (must come before generic /v1/)
    location ~ ^/v1/usage/(.*)$ {
        proxy_pass http://backend-api:8700/v1/usage/$1$is_args$args;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Template management endpoints to backend API (must come before generic /v1/)
    location = /v1/templates {
        proxy_pass http://backend-api:8700/v1/templates;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location ~ ^/v1/templates/(.*)$ {
        proxy_pass http://backend-api:8700/v1/templates/$1$is_args$args;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Direct metrics endpoint from llamacpp (uses variable for dynamic resolution)
    location = /metrics {
        set $llamacpp_upstream http://llamacpp-api:8080;
        proxy_pass $llamacpp_upstream/metrics;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization "Bearer placeholder-api-key";
    }

    # LlamaCPP API (uses variable for dynamic resolution)
    location /api/ {
        set $llamacpp_upstream http://llamacpp-api:8080;
        proxy_pass $llamacpp_upstream/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization "Bearer placeholder-api-key";
    }
    
    # Direct LlamaCPP API endpoints without /api prefix (uses variable for dynamic resolution)
    location ~ ^/v1/ {
        set $llamacpp_upstream http://llamacpp-api:8080;
        proxy_pass $llamacpp_upstream;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization "Bearer placeholder-api-key";
    }

    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}